---
title: "heat_parcels_processing"
output: html_document
editor_options: 
  chunk_output_type: console
---
```{r setup, include = F}
knitr::opts_chunk$set(warning = F, message = F)
```
```{r}
library(sf)
library(leaflet)
library(mapboxapi)
library(tigris)
library(tidyverse)
library(exactextractr)
library(stringr)
library(jsonlite)
```
```{r}
county_name <- "San Mateo"
city_name <- "East Palo Alto"
thresholds <- c(90, 95, 100, 105, 110)
```
```{r}
county <-
  counties("CA", cb = T, progress_bar = F) %>%
  filter(NAME == county_name) %>%
  st_transform(4326)

city <-
  places("CA") %>%
  filter(
    NAME == city_name
  )

cbgs <-
  block_groups("CA", county_name, cb = T, progress_bar = F)

# locas <-
#   readRDS("G:/Shared drives/SFBI-Restricted/W21 218Y Climate Data/loca_grids.rds") %>%
#   st_as_sf() %>%
#   .[county %>% st_transform(4326),]
```
```{r download_locas}
# max_temp_locas <- NULL
# 
# for (row in 1:nrow(locas)) {
#   temp <-
#     fromJSON(
#       paste0(
#         "https://api.cal-adapt.org/api/series/tasmax_day_ens32max_rcp85/events/?g=",
#         locas[row, ]$geometry %>%
#           st_as_text() %>%
#           str_replace_all(" ","+"),
#         "&stat=mean"
#       )
#     ) %>%
#     as.data.frame() %>%
#     rename(
#       date = "index",
#       max_temp = "data"
#     ) %>%
#     mutate(
#       max_temp = max_temp*9/5 - 459.67,
#       id = locas[row, ]$id
#     )
# 
#   max_temp_locas <-
#     max_temp_locas %>%
#     rbind(temp)
# }
# 
# saveRDS(max_temp_locas, "max_temp_locas.rds")
```
```{r}
# max_temp_locas_no_geom <- 
#   readRDS("max_temp_locas.rds") %>%
#   mutate(
#     year = substr(date, 1, 4),
#     month = substr(date, 6, 7),
#     day = substr(date, 9, 10)
#   )
  
```

```{r}
smc_parcels_geom <-
  readRDS("../EPA_Parcels_and_Hazards/smc_parcels_fixed.rds") %>% 
  select(APN)

smc_parcels_no_geom <-  
  readRDS("../EPA_Parcels_and_Hazards/smc_parcels_fixed.rds") %>%
  st_set_geometry(NULL)

smc_parcels <-
  smc_parcels_no_geom %>%
  select(
    APN,
    `PUC CODE`,
    `YEAR BUILT.x`,
    `CENTRAL HEATING.x`,
    `CENTRAL COOLING.x`,
    `STORIES.x`,
    `COMMON GREEN.x`,
    `WATER FRONT`,
    `DATE OF RECORD`
  ) %>%
  rename(
    puc_code = `PUC CODE`,
    year_built = `YEAR BUILT.x`,
    central_heating = `CENTRAL HEATING.x`,
    central_cooling = `CENTRAL COOLING.x`,
    stories = STORIES.x,
    common_green = `COMMON GREEN.x`,
    water_front = `WATER FRONT`
  ) %>%
  mutate(
    year_of_record = substr(`DATE OF RECORD`, 1, 4)
  ) %>%
  select(-c(`DATE OF RECORD`)) %>%
  left_join(smc_parcels_geom, by = "APN") %>%
  st_as_sf()

saveRDS(smc_parcels, "data/smc_parcels_clean.rds")
```
```{r split_locas_into_days_above_thresholds}
# threshold_locas <- NULL
# 
# for (threshold in thresholds) {
#   print(paste0("threshold: ", threshold))
#   
#   temp <-
#     max_temp_locas_no_geom %>%
#     group_by(year, id) %>%
#     summarize(
#       days_above_threshold =
#         sum(ifelse(max_temp > threshold, 1, 0))
#     ) %>%
#     mutate(
#       threshold_temp = paste0("above_", threshold)
#     )
#   
#   threshold_locas <-
#     rbind(threshold_locas, temp)
# }
```
```{r}
# old method, now updated with meg's data
# selected_years <- c(2020:2030)
# 
# locas_heat_selected_years_avg <-
#   threshold_locas %>%
#   filter(
#     year %in% selected_years
#   ) %>%
#   group_by(
#     id,
#     threshold_temp
#   ) %>%
#   summarize(
#     avg_days_per_year_above_threshold = mean(days_above_threshold)
#   ) %>%
#   rename(
#     days_above_threshold = avg_days_per_year_above_threshold
#   ) %>%
#   mutate(
#     days_above_threshold = round(days_above_threshold)
#   ) %>%
#   left_join(
#     locas,
#     by = "id"
#   ) %>%
#   ungroup() %>%
#   st_as_sf()
# 
# saveRDS(locas_heat_selected_years_avg, "locas_heat_selected_years_avg.rds")
```
```{r}
# meg's new data 5/5/21
locas_heat_selected_years_avg <-
  readRDS("new_exheat_tm_30yr_ave_locas_sf.rds") %>%
  st_as_sf() %>%
  select(threshold_temp, exheat_ave_tm) %>%
  rename(
    days_above_threshold = exheat_ave_tm
  )
```

```{r intersect_parcels_with_locas}
smc_parcels_heat <- NULL

for (threshold in thresholds) {
  print(paste0("threshold: ", threshold))
  
  selected_threshold <-
    locas_heat_selected_years_avg %>%
    filter(threshold_temp %in% c(paste0("above_", threshold))) %>%
    st_as_sf() %>%
    st_transform(4326)
  
  temp <-
    st_join(
      smc_parcels,
      selected_threshold
    )
  
  smc_parcels_heat <-
    smc_parcels_heat %>%
    rbind(temp)
}

saveRDS(smc_parcels_heat, "smc_parcels_heat.rds")

epa_parcels_heat <-
  smc_parcels_heat %>%
  st_centroid() %>%
  .[city %>% st_transform(4326),] %>%
  st_set_geometry(NULL) %>%
  left_join(smc_parcels_geom, by = "APN") %>% 
  st_as_sf()

saveRDS(epa_parcels_heat, "epa_parcels_heat.rds")
```
```{r}
smc_parcels_heat <-
  readRDS("smc_parcels_heat.rds")

smc_parcels_above_95_most_vulnerable <-
  smc_parcels_heat %>%
  filter(
    threshold_temp == "above_95"
  ) %>%
  filter(
    quantile(days_above_threshold, .75) < days_above_threshold,
    quantile(year_built, .25, na.rm = TRUE) > year_built
  )

saveRDS(smc_parcels_above_95_most_vulnerable, "smc_parcels_above_95_most_vulnerable.rds")

smc_cbgs_above_95_most_vulnerable <-
  st_join(
    smc_parcels_above_95_most_vulnerable, 
    cbgs %>% 
      st_transform(4326) %>%
      select(GEOID)
  ) %>%
  st_set_geometry(NULL) %>%
  group_by(GEOID) %>%
  summarize(num_vulnerable_parcels = n()) %>%
  left_join(cbgs %>% select(GEOID), by = "GEOID")

saveRDS(smc_cbgs_above_95_most_vulnerable, "smc_cbgs_above_95_most_vulnerable.rds")
```
```{r}
smc_cbgs_above_95_most_vulnerable <-
  readRDS("smc_cbgs_above_95_most_vulnerable.rds")

selected_cbg <-
  smc_cbgs_above_95_most_vulnerable %>%
  filter(GEOID == "060816099002") %>%
  st_as_sf()
```

```{r testing}
# selected_parcels <-
#   smc_cbgs_above_95_most_vulnerable %>%
#   st_as_sf()

selected_parcels <-
  smc_parcels_above_95_most_vulnerable %>%
  st_as_sf() %>%
  .[selected_cbg %>% st_transform(4326),] %>%
  mutate(days_above_threshold = ceiling(days_above_threshold))

# heat_pal <- colorNumeric(
#   palette = "Reds",
#   domain = selected_parcels$num_vulnerable_parcels
# )

heat_pal <- colorNumeric(
  palette = "Reds",
  domain = selected_parcels$days_above_threshold
)

# leaflet() %>%
#   addMapboxTiles(
#     style_id = "light-v9",
#     username = "mapbox",
#     access_token = "pk.eyJ1IjoibXNhdW5kZTIiLCJhIjoiY2tqenhlOTQ1MGJ2dzJvcnV3ZnA3eXdnaCJ9.3J2jMPRqbFu8cX1VjT_gDA"
#   ) %>%
#   addPolygons(
#     data = selected_parcels,
#     fillColor = ~heat_pal(num_vulnerable_parcels),
#     fillOpacity = 0.5,
#     color = "blue",
#     weight = 0.5,
#     label = ~paste0(GEOID, ": ", num_vulnerable_parcels, "  parcels"),
#     highlightOptions = highlightOptions(
#       weight = 2,
#       opacity = 1
#     )
#   ) %>%
#   addLegend(
#     data = selected_parcels,
#     pal = heat_pal,
#     values = ~num_vulnerable_parcels,
#     title = ~paste0("Number of parcels<br>that are most vulnerable over next decade")
#   )

leaflet() %>%
  addMapboxTiles(
    style_id = "light-v9",
    username = "mapbox",
    access_token = "pk.eyJ1IjoibXNhdW5kZTIiLCJhIjoiY2tqenhlOTQ1MGJ2dzJvcnV3ZnA3eXdnaCJ9.3J2jMPRqbFu8cX1VjT_gDA"
  ) %>%
  addPolygons(
    data = selected_parcels,
    fillColor = ~heat_pal(days_above_threshold),
    fillOpacity = 0.5,
    color = "blue",
    weight = 0.5,
    label = ~paste0(APN, ": ", days_above_threshold, " days above 95"),
    highlightOptions = highlightOptions(
      weight = 2,
      opacity = 1
    )
  ) %>%
  addLegend(
    data = selected_parcels,
    pal = heat_pal,
    values = ~days_above_threshold,
    title = ~paste0("Number of days above 95 degrees over the next decade")
  )
```



