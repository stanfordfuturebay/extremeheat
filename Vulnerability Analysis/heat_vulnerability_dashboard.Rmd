---
title: "SMC Heat and Vulnerable Parcels Dashboard"
runtime: shiny
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
    vertical_layout: fill
    source_code: embed
---

```{r global, include=FALSE}
library(flexdashboard)
library(htmltools)
library(tidyverse)
library(sf)
library(leaflet)
library(mapboxapi)
library(tigris)
library(shinydashboard)
library(shiny)

default_building_age <- 0
default_svi <- 0
default_heat <- 0
default_under_5 <- 0
default_above_65 <- 0
default_limited_eng <- 0
default_disabled <- 0
default_poverty <- 0
default_no_vehicle <- 0

smc_parcels_vulnerability <-
  readRDS("data/smc_parcels_vulnerability.rds")

smc_cbgs <-
  readRDS("data/smc_cbgs.rds") %>%
  rename(CBG = GEOID)
```
Home
===================================== 

Inputs {.sidebar}
-----------------------------------------------------------------------

**Map** - shows the number of vulnerable parcels above input thresholds in each CBG in San Mateo County. 

**Click on** any cbg to view parcels.

**Thresholds** on sliders are defaulted to 0, so all cbgs and parcels in SMC are shown. If you slide any thresholds to the right, you'll filter out parcels underneath the threshold. 

**Scroll down** for a fuller description of the sliders and data sources.

```{r, context="server"}
sliderInput(
  "building_age",
  label = "Building Age (years old)",
  min = 0,
  max = max(smc_parcels_vulnerability$building_age),
  value = default_building_age,
  step = 10
)

sliderInput(
  "heat_above_95",
  label = "Days Above 95 F",
  min = 0,
  max = max(smc_parcels_vulnerability$weighted_tm_ave),
  value = default_heat
)

sliderInput(
  "svi",
  label = "Social Vulnerability Index",
  min = 0,
  max = 100,
  value = default_svi
)

sliderInput(
  "under_5",
  label = "Percent Under 5 Yrs Old",
  min = 0,
  max = 100,
  value = default_under_5
)

sliderInput(
  "above_65",
  label = "Percent Above 65 Yrs Old",
  min = 0,
  max = 100,
  value = default_above_65
)

sliderInput(
  "limited_eng",
  label = "Percent w/ Limited English",
  min = 0,
  max = 100,
  value = default_limited_eng
)

sliderInput(
  "disabled",
  label = "Percent w/ Disability",
  min = 0,
  max = 100,
  value = default_disabled
)

sliderInput(
  "poverty",
  label = "Percent in Poverty",
  min = 0,
  max = 100,
  value = default_poverty
)

sliderInput(
  "no_vehicle",
  label = "Percent w/o a Vehicle",
  min = 0,
  max = 100,
  value = default_no_vehicle
)

```
**Building Age** is derived from the "year built" variable in the SMC assessor data. Older buildings are more vulnerable to extreme heat events.

**Days Above 95 F** uses [CalAdapt](https://cal-adapt.org/data/download/) data and is the predicted number of days per year that will be above 95 degrees Fahrenheit, averaged between 2016-2045. For more information, see our [extreme heat dashboard](https://stanfordfuturebay.shinyapps.io/sanmateo_heat/).

**Social Vulnerability Index** is a [CDC measure](https://www.atsdr.cdc.gov/placeandhealth/svi/index.html) that uses U.S. Census data from the 2019 American Communities Survey (acs5) to determine the relative social vulnerability of every census tract.

**Other Census ACS Variables** are listed as slider options, despite most of them being encapsulated by SVI, because they are more specific to extreme heat vulnerability.

Row {data-height=600}
-----------------------------------------------------------------------

### {.no-padding}

```{r}
leafletOutput("map")
```
```{r, context="server"}
default_parcels <-
  smc_parcels_vulnerability %>%
  filter(
    building_age >= default_building_age,
    weighted_tm_ave >= default_heat,
    SVI >= default_svi,
    UNDER_5 >= default_under_5,
    EP_AGE65 >= default_above_65,
    EP_LIMENG >= default_limited_eng,
    EP_DISABL >= default_disabled,
    EP_POV >= default_poverty,
    EP_NOVEH >= default_no_vehicle
  )

default_cbgs <-
  default_parcels %>%
  st_set_geometry(NULL) %>%
  group_by(CBG) %>%
  summarize(num_parcels = n()) %>%
  ungroup() %>%
  left_join(smc_cbgs) %>%
  st_as_sf()

selected_parcels <-
  reactiveVal(default_parcels)

selected_cbgs <-
  reactiveVal(default_cbgs)

output$map <- renderLeaflet({
  heat_pal <- colorNumeric(
    palette = "Reds",
    domain = selected_cbgs()$num_parcels
  )
  
  leaflet() %>%
    addProviderTiles(providers$CartoDB.Positron, group = "Minimal Basemap") %>%
    addMapboxTiles(
      style_id = "satellite-streets-v11",
      username = "mapbox",
      access_token = "pk.eyJ1IjoiZGVyZWtvdXlhbmciLCJhIjoiY2s5Yno5bXByMDM1djNlcDhsMTFqM3VjcyJ9.bcf4iQucxDFqq-0a9bwmsQ",
      group = "Satellite Basemap"
    ) %>%
    addMapboxTiles(
      style_id = "streets-v11",
      username = "mapbox",
      access_token = "pk.eyJ1IjoiZGVyZWtvdXlhbmciLCJhIjoiY2s5Yno5bXByMDM1djNlcDhsMTFqM3VjcyJ9.bcf4iQucxDFqq-0a9bwmsQ",
      group = "Streets Basemap"
    ) %>%
    addPolygons(
      data = selected_cbgs(),
      fillColor = ~heat_pal(num_parcels),
      fillOpacity = 0.5,
      color = "blue",
      weight = 0.5,
      label = ~paste0("CBG ", CBG, ": ", num_parcels," parcels"),
      highlightOptions = highlightOptions(
        weight = 2,
        opacity = 1
      )
    ) %>%
    addLayersControl(
      baseGroups = c("Minimal Basemap", "Satellite Basemap", "Streets Basemap")
      ) %>%
    showGroup("Minimal Basemap") %>%
    addLegend(
      data = selected_cbgs(),
      pal = heat_pal,
      values = ~num_parcels,
      title = "Number of vulnerable parcels<br>in each CBG",
      layerId = "legend"
    )
})
```
```{r, context = "server"}
observeEvent({
  input$building_age 
  input$heat_above_95 
  input$svi 
  input$under_5 
  input$above_65
  input$limited_eng
  input$disabled
  input$poverty
  input$no_vehicle
  }, {
  
  selected_parcels(
    smc_parcels_vulnerability %>%
    filter(
      building_age >= input$building_age,
      weighted_tm_ave >= input$heat_above_95,
      SVI >= input$svi,
      UNDER_5 >= input$under_5,
      EP_AGE65 >= input$above_65,
      EP_LIMENG >= input$limited_eng,
      EP_DISABL >= input$disabled,
      EP_POV >= input$poverty,
      EP_NOVEH >= input$no_vehicle
    )
  )

  selected_cbgs(
    selected_parcels() %>%
    st_set_geometry(NULL) %>%
    group_by(CBG) %>%
    summarize(num_parcels = n()) %>%
    ungroup() %>%
    left_join(smc_cbgs) %>%
    st_as_sf()
  )
  
  heat_pal <- colorNumeric(
    palette = "Reds",
    domain = selected_cbgs()$num_parcels
  )
  
  leafletProxy("map") %>%
    clearShapes() %>%
    removeControl(layerId = "legend") %>%
    addPolygons(
      data = selected_cbgs(),
      fillColor = ~heat_pal(num_parcels),
      fillOpacity = 0.5,
      color = "blue",
      weight = 0.5,
      label = paste0("CBG ", selected_cbgs()$CBG, ": ", selected_cbgs()$num_parcels," parcels"),
      highlightOptions = highlightOptions(
        weight = 2,
        opacity = 1
      ),
      group = "initial"
    ) %>%
    addLegend(
      data = selected_cbgs(),
      pal = heat_pal,
      values = ~num_parcels,
      title = "Number of vulnerable parcels<br>in each CBG",
      layerId = "legend"
    )

})
```
```{r, context = "server"}
observeEvent(input$map_click, {
    leafletProxy('map') %>%
      clearGroup(group = "select")
    
    click <- input$map_click
    
    selected_ZONE <-
      st_point(c(click$lng,click$lat)) %>%
      st_sfc() %>%
      st_sf() %>%
      st_set_crs(st_crs(selected_cbgs())) %>%
      selected_cbgs()[., ]
    
    if (nrow(selected_ZONE) == 0)
      return()
    else {
      viewing_parcels <- selected_parcels() %>%
        filter(CBG == selected_ZONE[1, ]$CBG)
      
      bbox <- as.numeric(st_bbox(selected_ZONE))
      
      leafletProxy('map') %>%
        # addPolygons(
        #   data = selected_ZONE,
        #   fillOpacity = 0,
        #   opacity = 0,
        #   # label = ~paste0("CBG ", CBG, ": ", num_parcels," parcels"),
        #   group = "select"
        # ) %>%
        # hideGroup("initial") %>%
        flyToBounds(
          lng1 = bbox[1],
          lat1 = bbox[2],
          lng2 = bbox[3],
          lat2 = bbox[4]
        ) %>%
        addPolygons(
          data = viewing_parcels,
          fillColor = "blue",
          weight = 1,
          color = "black",
          label = ~paste0("APN ", APN),
          group = "select"
        )
    }
})
```
```{r}
observeEvent(input$map_zoom, {
  if (input$map_zoom > 10) {
    # zoomed in on parcels
    leafletProxy("map") %>%
      # hideGroup("initial") %>%
      showGroup("select")
  } else {
    # initial zoom level
    leafletProxy("map") %>%
      # showGroup("initial") %>%
      hideGroup("select")
  }
})
```


