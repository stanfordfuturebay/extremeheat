---
title: "census_heat_vulnerability"
output: html_document
---
```{r setup, include = F}
knitr::opts_chunk$set(warning = F, message = F)
```
```{r}
library(tidyverse)
library(sf)
library(tigris)
library(leaflet)
library(censusapi)
library(mapboxapi)

Sys.setenv(CENSUS_KEY = "c8aa67e4086b4b5ce3a8717f59faa9a28f611dab")

acs_vars_2019_5yr <-
  listCensusMetadata(
    name = "2019/acs/acs5",
    type = "variables"
  )
```
```{r}
county_name <- "San Mateo"
city_name <- "East Palo Alto"
state_id <- "06"
county_id <- "081"

county <-
  counties("CA", cb = T, progress_bar = F) %>%
  filter(NAME == county_name) %>%
  st_transform(4326)

city <-
  places("CA") %>%
  filter(
    NAME == city_name
  )

smc_blockgroups <- 
  block_groups("CA", "San Mateo", cb = T, progress_bar = F)

epa_blockgroups <-
  smc_blockgroups %>%
  st_centroid() %>%
  .[city,]
```

```{r}
smc_sexbyage <-
  getCensus(
    name = "acs/acs5",
    vintage = 2019,
    region = "block group:*", 
    regionin = paste0("state:",state_id,"+county:",county_id),
    vars = "group(B01001)"
  ) %>%
  mutate(
    cbg =
      paste0(state,county,tract,block_group)
  ) %>% 
  select(!c(GEO_ID,state,county,tract,block_group,NAME) & !ends_with(c("EA","MA","M"))) %>%
  pivot_longer(
    ends_with("E"),
    names_to = "variable",
    values_to = "estimate"
  ) %>%
  left_join(
    acs_vars_2019_5yr %>% 
      select(name, label), 
    by = c("variable" = "name") 
  ) %>%
  select(-variable) %>% 
  separate(
    label,
    into = c(NA,NA,"sex","age"),
    sep = "!!"
  ) %>% 
  filter(!is.na(age))


```
```{r}
over_65 <- 
  c(
    "65 and 66 years",
    "67 to 69 years",
    "70 to 74 years",
    "75 to 79 years",
    "80 to 84 years",
    "85 years and over"
  )

smc_elderly <- 
  smc_sexbyage %>% 
  mutate(
    elderly = 
      ifelse(
        age %in% over_65,
        estimate,
        NA
      )
  ) %>% 
  group_by(cbg) %>% 
  summarize(
    elderly = sum(elderly, na.rm = T),
    total_pop = sum(estimate, na.rm = T)
  ) %>% 
  mutate(
    percent_elderly = elderly/total_pop*100
  ) %>% 
  filter(!is.na(percent_elderly))
```
```{r}
# elderly_pal <- colorNumeric(
#   palette = "Blues",
#   domain = 
#     smc_elderly$percent_elderly
# )
# 
# leaflet() %>% 
#   addMapboxTiles(
#     style_id = "light-v9",
#     username = "mapbox"
#   ) %>% 
#   addPolygons(
#     data = 
#       smc_elderly %>% 
#         left_join(
#           smc_blockgroups %>% select(GEOID), 
#           by = c("cbg" = "GEOID")
#         ) %>% 
#         st_as_sf() %>%
#         st_transform(4326),
#     fillColor = ~elderly_pal (percent_elderly),
#     color = "white",
#     opacity = 0.5,
#     fillOpacity = 0.5,
#     weight = 1,
#     label = ~paste0(
#       round(percent_elderly), 
#       "% over age 65"
#     ),
#     highlightOptions = highlightOptions(
#       weight = 2,
#       opacity = 1
#     )
#   ) %>% 
#   addLegend(
#     data = smc_elderly,
#     pal = elderly_pal,
#     values = ~percent_elderly,
#     title = "% over 65"
#   )
```
```{r}
smc_under_5 <- 
  smc_sexbyage %>% 
  mutate(
    under_5 = 
      ifelse(
        age == "Under 5 years",
        estimate,
        NA
      )
  ) %>% 
  group_by(cbg) %>% 
  summarize(
    under_5 = sum(under_5, na.rm = T),
    total_pop = sum(estimate, na.rm = T)
  ) %>% 
  mutate(
    percent_under_5 = under_5/total_pop*100
  ) %>% 
  filter(!is.na(percent_under_5))
```
```{r}
# under_5_pal <- colorNumeric(
#   palette = "Reds",
#   domain = 
#     smc_under_5$percent_under_5
# )
# 
# leaflet() %>% 
#   addMapboxTiles(
#     style_id = "light-v9",
#     username = "mapbox"
#   ) %>% 
#   addPolygons(
#     data = 
#       smc_under_5 %>% 
#         left_join(
#           smc_blockgroups %>% select(GEOID), 
#           by = c("cbg" = "GEOID")
#         ) %>% 
#         st_as_sf() %>%
#         st_transform(4326),
#     fillColor = ~under_5_pal (percent_under_5),
#     color = "white",
#     opacity = 0.5,
#     fillOpacity = 0.5,
#     weight = 1,
#     label = ~paste0(
#       round(percent_under_5), 
#       "% under age 5"
#     ),
#     highlightOptions = highlightOptions(
#       weight = 2,
#       opacity = 1
#     )
#   ) %>% 
#   addLegend(
#     data = smc_under_5,
#     pal = under_5_pal,
#     values = ~percent_under_5,
#     title = "% under 5"
#   )
```
```{r}
smc_tenurebyvehicle <-
  getCensus(
    name = "acs/acs5",
    vintage = 2019,
    region = "block group:*", 
    regionin = paste0("state:",state_id,"+county:",county_id),
    vars = "group(B25044)"
  ) %>%
  mutate(
    cbg =
      paste0(state,county,tract,block_group)
  ) %>% 
  select(!c(GEO_ID,state,county,tract,block_group,NAME) & !ends_with(c("EA","MA","M"))) %>%
  pivot_longer(
    ends_with("E"),
    names_to = "variable",
    values_to = "estimate"
  ) %>%
  left_join(
    acs_vars_2019_5yr %>% 
      select(name, label), 
    by = c("variable" = "name") 
  ) %>%
  select(-variable) %>% 
  separate(
    label,
    into = c(NA,NA,"tenure","vehicle"),
    sep = "!!"
  ) %>% 
  filter(!is.na(vehicle))
```
```{r}
smc_no_vehicle <-
  smc_tenurebyvehicle %>%
  mutate(
    no_vehicle = 
      ifelse(
        vehicle == "No vehicle available",
        estimate,
        NA
      )
  ) %>% 
  group_by(cbg) %>% 
  summarize(
    no_vehicle = sum(no_vehicle, na.rm = T),
    total_pop = sum(estimate, na.rm = T)
  ) %>% 
  mutate(
    percent_no_vehicle = no_vehicle/total_pop*100
  ) %>% 
  filter(!is.na(percent_no_vehicle))
  
```
```{r}
# no_vehicle_pal <- colorNumeric(
#   palette = "Greens",
#   domain = 
#     smc_no_vehicle$percent_no_vehicle
# )
# 
# leaflet() %>% 
#   addMapboxTiles(
#     style_id = "light-v9",
#     username = "mapbox"
#   ) %>% 
#   addPolygons(
#     data = 
#       smc_no_vehicle %>% 
#         left_join(
#           smc_blockgroups %>% select(GEOID), 
#           by = c("cbg" = "GEOID")
#         ) %>% 
#         st_as_sf() %>%
#         st_transform(4326),
#     fillColor = ~no_vehicle_pal (percent_no_vehicle),
#     color = "white",
#     opacity = 0.5,
#     fillOpacity = 0.5,
#     weight = 1,
#     label = ~paste0(
#       round(percent_no_vehicle), 
#       "% no vehicle"
#     ),
#     highlightOptions = highlightOptions(
#       weight = 2,
#       opacity = 1
#     )
#   ) %>% 
#   addLegend(
#     data = smc_no_vehicle,
#     pal = no_vehicle_pal,
#     values = ~percent_no_vehicle,
#     title = "% without a vehicle"
#   )
```
```{r}
smc_povertybyfamilytype <-
  getCensus(
    name = "acs/acs5",
    vintage = 2019,
    region = "block group:*", 
    regionin = paste0("state:",state_id,"+county:",county_id),
    vars = "group(B17010)"
  ) %>%
  mutate(
    cbg =
      paste0(state,county,tract,block_group)
  ) %>% 
  select(!c(GEO_ID,state,county,tract,block_group,NAME) & !ends_with(c("EA","MA","M"))) %>%
  pivot_longer(
    ends_with("E"),
    names_to = "variable",
    values_to = "estimate"
  ) %>%
  left_join(
    acs_vars_2019_5yr %>% 
      select(name, label), 
    by = c("variable" = "name") 
  ) %>%
  select(-variable) %>%
  separate(
    label,
    into = c(NA,NA,"income_below_poverty","related_family","related_family_type"),
    sep = "!!"
  ) %>% 
  filter(!is.na(income_below_poverty))
```
```{r}
smc_below_poverty <-
  smc_povertybyfamilytype %>%
  mutate(
    below_poverty = 
      ifelse(
        income_below_poverty == "Income in the past 12 months below poverty level:",
        estimate,
        NA
      )
  ) %>% 
  group_by(cbg) %>% 
  summarize(
    below_poverty = sum(below_poverty, na.rm = T),
    total_pop = sum(estimate, na.rm = T)
  ) %>% 
  mutate(
    percent_below_poverty = below_poverty/total_pop*100
  ) %>% 
  filter(!is.na(percent_below_poverty))
```
```{r}
# below_poverty_pal <- colorNumeric(
#   palette = "Oranges",
#   domain = 
#     smc_below_poverty$percent_below_poverty
# )
# 
# leaflet() %>% 
#   addMapboxTiles(
#     style_id = "light-v9",
#     username = "mapbox"
#   ) %>% 
#   addPolygons(
#     data = 
#       smc_below_poverty %>% 
#         left_join(
#           smc_blockgroups %>% select(GEOID), 
#           by = c("cbg" = "GEOID")
#         ) %>% 
#         st_as_sf() %>%
#         st_transform(4326),
#     fillColor = ~below_poverty_pal (percent_below_poverty),
#     color = "white",
#     opacity = 0.5,
#     fillOpacity = 0.5,
#     weight = 1,
#     label = ~paste0(
#       round(percent_below_poverty), 
#       "% with income below poverty"
#     ),
#     highlightOptions = highlightOptions(
#       weight = 2,
#       opacity = 1
#     )
#   ) %>% 
#   addLegend(
#     data = smc_below_poverty,
#     pal = below_poverty_pal,
#     values = ~percent_below_poverty,
#     title = "% with income below poverty level"
#   )
```
```{r}
saveRDS(smc_elderly, "data/smc_elderly.rds")
saveRDS(smc_no_vehicle, "data/smc_no_vehicle.rds")
saveRDS(smc_under_5, "data/smc_under_5.rds")
saveRDS(smc_below_poverty, "data/smc_below_poverty.rds")
```








