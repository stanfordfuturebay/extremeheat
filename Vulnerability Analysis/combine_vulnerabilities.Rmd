---
title: "Combine Vulerabilities"
output: html_document
---

```{r setup, include = F}
knitr::opts_chunk$set(warning = F, message = F)
```
```{r}
library(tidyverse)
library(sf)
library(tigris)
library(leaflet)
library(censusapi)
library(mapboxapi)

Sys.setenv(CENSUS_KEY = "c8aa67e4086b4b5ce3a8717f59faa9a28f611dab")
```
```{r}
cbgs <-
  readRDS("data/smc_cbgs.rds")
```
```{r}
smc_cbgs_acs_2019 <-
  readRDS("data/smc_cbgs_acs_2019.rds")

smc_under_5 <-
  readRDS("data/smc_under_5.rds") %>%
  select(c(cbg, percent_under_5)) %>%
  rename(
    CBG = cbg,
    UNDER_5 = percent_under_5
  )

smc_cbgs_heat <-
  readRDS("data/new_exheat_tm_30yr_thresholds.rds") %>%
  rename(
    CBG = GEOID
  ) %>%
  filter(
    threshold_temp == "above_95"
  ) %>%
  select(c(CBG, weighted_tm_ave))

smc_cbgs_acs_2019_combined <-
  smc_cbgs_acs_2019 %>%
  left_join(smc_under_5) %>%
  left_join(smc_cbgs_heat) %>%
  select(
    c("CBG", "UNDER_5", "EP_AGE65", "SVI", "EP_LIMENG", "EP_DISABL",
        "EP_POV", "EP_NOVEH", "weighted_tm_ave")
  ) %>%
  left_join(cbgs, by = c("CBG" = "GEOID")) %>%
  st_as_sf() %>%
  st_transform(4326)
```
```{r}
smc_parcels <-
  readRDS("data/smc_parcels_clean.rds") %>%
  select(c(APN, year_built, central_cooling)) %>%
  mutate(
    building_age = 2021 - year_built
  )

smc_parcels_vulnerability <-
  st_join(
    smc_parcels,
    smc_cbgs_acs_2019_combined
  ) %>%
  filter(
    !is.na(year_built),
    year_built >= 1700,
    year_built <= 2021,
    !is.na(weighted_tm_ave)
  ) %>%
  mutate(
    weighted_tm_ave = round(weighted_tm_ave)
  )

saveRDS(smc_parcels_vulnerability, "data/smc_parcels_vulnerability.rds")
```

